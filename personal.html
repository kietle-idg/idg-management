<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My View | IDGX Capital</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-inner">
        <a href="index.html" class="navbar-brand">
          <div class="navbar-logo">IDGX</div>
          <span>IDGX Capital</span>
        </a>
        
        <div class="navbar-nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="portfolio.html" class="nav-link" id="nav-portfolio">Portfolio</a>
          <a href="personal.html" class="nav-link active">My View</a>
          <a href="documents.html" class="nav-link" id="nav-documents">Documents</a>
          <a href="admin.html" class="nav-link" id="nav-admin">Admin</a>
        </div>

        <div class="navbar-user">
          <div class="user-menu">
            <button class="user-button">
              <div class="user-avatar" id="user-avatar">--</div>
              <span id="user-name">Loading...</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div class="user-dropdown">
              <div class="dropdown-item" style="pointer-events: none; padding-bottom: 8px;">
                <small style="color: var(--text-muted);">Signed in as <span id="user-role-text">-</span></small>
              </div>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" onclick="Auth.signOut()">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="container container-lg">
        <!-- Loading State -->
        <div id="loading-state" class="loading">
          <div class="spinner"></div>
        </div>

        <!-- Personal Content -->
        <div id="personal-content" class="hidden">
          <!-- Page Header with Date -->
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <h1 class="page-title">Welcome back, <span id="greeting-name">User</span></h1>
              <p class="page-subtitle">Here's what's on your plate today</p>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 32px; font-weight: 600; color: var(--text-primary);" id="today-date"></div>
              <div style="color: var(--text-muted);" id="today-day"></div>
            </div>
          </div>

          <!-- Two Column Layout -->
          <div class="grid-2">
            <!-- Upcoming Events from Google Calendar -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ðŸ“… My Calendar</h3>
                <button class="btn btn-ghost btn-sm" id="connect-calendar-btn" onclick="connectGoogleCalendar()" style="display: none;">
                  Connect Calendar
                </button>
              </div>
              <div class="card-body">
                <div id="calendar-loading" style="display: none; padding: 24px; text-align: center;">
                  <div class="spinner" style="margin: 0 auto;"></div>
                  <p style="margin-top: 12px; color: var(--text-muted);">Loading calendar...</p>
                </div>
                <div id="calendar-connect" style="display: none; padding: 24px; text-align: center;">
                  <p style="color: var(--text-muted); margin-bottom: 16px;">Connect your Google Calendar to see upcoming events</p>
                  <button class="btn btn-primary" onclick="connectGoogleCalendar()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Connect Google Calendar
                  </button>
                </div>
                <ul class="list" id="events-list"></ul>
              </div>
            </div>

            <!-- Action Items -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Action Items</h3>
                <span class="badge badge-primary" id="tasks-count">0</span>
              </div>
              <div class="card-body">
                <ul class="list" id="tasks-list"></ul>
              </div>
            </div>
          </div>

          <!-- My Companies -->
          <div id="my-companies-section" class="card mt-8 hidden">
            <div class="card-header">
              <h3 class="card-title">My Portfolio Companies</h3>
            </div>
            <div class="card-body no-padding">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Company</th>
                      <th>Stage</th>
                      <th class="text-right">Valuation</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="my-companies-table"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="database.js"></script>
  
  <!-- Google API for Calendar -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  
  <script>
    let companiesData = [];
    let eventsData = [];
    let tasksData = [];
    let calendarEvents = [];
    
    // Google Calendar Config - uses same project as Google Drive
    const GOOGLE_CLIENT_ID = '728812948064-XXXXX.apps.googleusercontent.com'; // Will be set from env
    const CALENDAR_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    let tokenClient = null;
    let gapiInited = false;
    let gisInited = false;

    // Initialize Google API
    function initGoogleAPI() {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
        });
        gapiInited = true;
        maybeLoadCalendar();
      });
    }

    // Check if we have a stored token
    function getStoredCalendarToken() {
      return localStorage.getItem('googleCalendarToken');
    }

    function storeCalendarToken(token) {
      localStorage.setItem('googleCalendarToken', token);
    }

    function clearCalendarToken() {
      localStorage.removeItem('googleCalendarToken');
    }

    // Connect to Google Calendar using Google Identity Services
    async function connectGoogleCalendar() {
      document.getElementById('calendar-loading').style.display = 'block';
      document.getElementById('calendar-connect').style.display = 'none';
      document.getElementById('events-list').innerHTML = '';
      
      try {
        // Use Google Identity Services for OAuth
        const client = google.accounts.oauth2.initTokenClient({
          client_id: '728812948064-2kdc14o4emgtn9ak4tioqme5d62ev6sa.apps.googleusercontent.com',
          scope: 'https://www.googleapis.com/auth/calendar.readonly',
          callback: async (response) => {
            if (response.access_token) {
              storeCalendarToken(response.access_token);
              await fetchCalendarEvents(response.access_token);
            } else {
              document.getElementById('calendar-loading').style.display = 'none';
              document.getElementById('calendar-connect').style.display = 'block';
              showToast('Could not get calendar access', true);
            }
          },
          error_callback: (error) => {
            console.error('OAuth error:', error);
            document.getElementById('calendar-loading').style.display = 'none';
            document.getElementById('calendar-connect').style.display = 'block';
            showToast('Could not connect to calendar', true);
          }
        });
        
        client.requestAccessToken();
      } catch (error) {
        console.error('Calendar connection error:', error);
        document.getElementById('calendar-loading').style.display = 'none';
        document.getElementById('calendar-connect').style.display = 'block';
        showToast('Could not connect to calendar: ' + error.message, true);
      }
    }

    // Fetch events from Google Calendar
    async function fetchCalendarEvents(token) {
      try {
        const now = new Date().toISOString();
        const maxDate = new Date();
        maxDate.setDate(maxDate.getDate() + 30); // Next 30 days
        
        const response = await fetch(
          `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
          `timeMin=${encodeURIComponent(now)}&` +
          `timeMax=${encodeURIComponent(maxDate.toISOString())}&` +
          `maxResults=20&` +
          `singleEvents=true&` +
          `orderBy=startTime`,
          {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          }
        );
        
        if (!response.ok) {
          if (response.status === 401) {
            // Token expired, clear and show connect button
            clearCalendarToken();
            document.getElementById('calendar-loading').style.display = 'none';
            document.getElementById('calendar-connect').style.display = 'block';
            return;
          }
          throw new Error('Failed to fetch calendar');
        }
        
        const data = await response.json();
        calendarEvents = data.items || [];
        
        document.getElementById('calendar-loading').style.display = 'none';
        document.getElementById('connect-calendar-btn').style.display = 'block';
        document.getElementById('connect-calendar-btn').textContent = 'Refresh';
        
        renderCalendarEvents();
      } catch (error) {
        console.error('Error fetching calendar:', error);
        document.getElementById('calendar-loading').style.display = 'none';
        document.getElementById('calendar-connect').style.display = 'block';
      }
    }

    // Try to load calendar if we have a stored token
    async function maybeLoadCalendar() {
      const token = getStoredCalendarToken();
      if (token) {
        document.getElementById('calendar-loading').style.display = 'block';
        document.getElementById('calendar-connect').style.display = 'none';
        await fetchCalendarEvents(token);
      } else {
        document.getElementById('calendar-connect').style.display = 'block';
      }
    }

    // Render calendar events
    function renderCalendarEvents() {
      if (calendarEvents.length === 0) {
        document.getElementById('events-list').innerHTML = 
          '<li class="empty-state" style="padding: 24px;"><p>No upcoming events in your calendar</p></li>';
        return;
      }

      const html = calendarEvents.map(event => {
        const start = event.start.dateTime || event.start.date;
        const date = new Date(start);
        const d = {
          day: date.getDate(),
          month: date.toLocaleDateString('en-US', { month: 'short' })
        };
        
        const time = event.start.dateTime 
          ? date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
          : 'All day';
        
        const location = event.location || 'No location';
        
        return `
          <li class="list-item">
            <div class="event-date">
              <div class="event-day">${d.day}</div>
              <div class="event-month">${d.month}</div>
            </div>
            <div class="event-content">
              <div class="event-title">${event.summary || 'Untitled Event'}</div>
              <div class="event-meta">${time} Â· ${location}</div>
            </div>
          </li>
        `;
      }).join('');

      document.getElementById('events-list').innerHTML = html;
    }

    // Toast notification
    function showToast(message, isError = false) {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 24px;
        background: ${isError ? '#EF4444' : '#10B981'};
        color: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function init() {
      // Check authentication
      await Auth.init();
      
      if (!Auth.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }

      const user = Auth.currentUserData;
      const role = user?.role;

      // Update navbar
      document.getElementById('user-name').textContent = user?.name || 'User';
      document.getElementById('user-avatar').textContent = user?.name?.split(' ').map(n => n[0]).join('') || '?';
      document.getElementById('user-role-text').textContent = role || '';

      // Show/hide nav items based on role
      if (role !== 'Admin') {
        document.getElementById('nav-admin').style.display = 'none';
      }
      if (role === 'LP') {
        document.getElementById('nav-portfolio').style.display = 'none';
      }
      
      // Update greeting
      document.getElementById('greeting-name').textContent = user?.name?.split(' ')[0] || 'there';
      
      // Update date
      const today = new Date();
      document.getElementById('today-date').textContent = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      document.getElementById('today-day').textContent = today.toLocaleDateString('en-US', { weekday: 'long' });

      // Load data from Firebase
      companiesData = await Database.getCompanies();
      tasksData = await Database.getTasks();

      // Try to load Google Calendar events
      maybeLoadCalendar();
      
      renderTasks();
      
      if (role !== 'LP') {
        renderMyCompanies();
      }
      
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('personal-content').classList.remove('hidden');
    }

    // Formatting functions
    function formatCurrency(amount) {
      if (!amount) return '$0';
      if (amount >= 1000000000) return '$' + (amount / 1000000000).toFixed(1) + 'B';
      if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(1) + 'M';
      if (amount >= 1000) return '$' + (amount / 1000).toFixed(0) + 'K';
      return '$' + amount.toLocaleString();
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatDateShort(dateString) {
      if (!dateString) return { day: '--', month: '---' };
      const date = new Date(dateString);
      return {
        day: date.getDate(),
        month: date.toLocaleDateString('en-US', { month: 'short' })
      };
    }

    function getDaysUntil(dateString) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const target = new Date(dateString);
      target.setHours(0, 0, 0, 0);
      return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
    }

    function getStageBadgeClass(stage) {
      if (stage === 'Seed') return 'badge-warning';
      if (stage === 'Series A') return 'badge-success';
      if (stage === 'Series B') return 'badge-primary';
      if (stage === 'Exited') return 'badge-default';
      return 'badge-default';
    }

    function renderEvents() {
      const user = Auth.currentUserData;
      let events = eventsData
        .filter(e => getDaysUntil(e.date) >= 0)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      // Filter by attendee
      if (user?.id) {
        events = events.filter(e => e.attendees?.includes(user.id) || user.role === 'GP' || user.role === 'Admin');
      }
      
      events = events.slice(0, 8);

      const html = events.map(e => {
        const d = formatDateShort(e.date);
        return `
          <li class="list-item">
            <div class="event-date">
              <div class="event-day">${d.day}</div>
              <div class="event-month">${d.month}</div>
            </div>
            <div class="event-content">
              <div class="event-title">${e.title}</div>
              <div class="event-meta">${e.time} Â· ${e.location}<span class="event-type">${e.type}</span></div>
            </div>
          </li>
        `;
      }).join('');

      document.getElementById('events-list').innerHTML = html || '<li class="empty-state" style="padding: 24px;"><p>No upcoming events</p></li>';
    }

    function renderTasks() {
      const user = Auth.currentUserData;
      let tasks = tasksData
        .filter(t => t.status !== 'completed')
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

      // Filter by assignee
      if (user?.id) {
        tasks = tasks.filter(t => t.assignee === user.id || user.role === 'GP' || user.role === 'Admin');
      }
      
      tasks = tasks.slice(0, 8);
      
      document.getElementById('tasks-count').textContent = tasks.length;

      const html = tasks.map(t => {
        const days = getDaysUntil(t.dueDate);
        let dueText = formatDate(t.dueDate);
        let overdue = false;
        
        if (days < 0) {
          dueText = `${Math.abs(days)} days overdue`;
          overdue = true;
        } else if (days === 0) {
          dueText = 'Due today';
        } else if (days === 1) {
          dueText = 'Due tomorrow';
        }

        return `
          <li class="task-item">
            <div class="task-checkbox"></div>
            <div class="task-content">
              <div class="task-title">${t.title}</div>
              <div class="task-meta">${t.type}</div>
            </div>
            <div class="task-due ${overdue ? 'overdue' : ''}">
              <span class="badge badge-${t.priority === 'high' ? 'danger' : t.priority === 'medium' ? 'warning' : 'default'}">${t.priority}</span>
              <div style="margin-top: 4px; font-size: 13px;">${dueText}</div>
            </div>
          </li>
        `;
      }).join('');

      document.getElementById('tasks-list').innerHTML = html || '<li class="empty-state" style="padding: 24px;"><p>No pending tasks</p></li>';
    }

    function renderMyCompanies() {
      const user = Auth.currentUserData;
      let companies = [];
      
      if (user?.role === 'Team' && user.assignedCompanies) {
        companies = companiesData.filter(c => user.assignedCompanies.includes(c.id));
      } else if (user?.role === 'GP' || user?.role === 'Admin') {
        companies = companiesData.filter(c => c.status === 'Active').slice(0, 6);
      }

      if (companies.length === 0) return;
      
      document.getElementById('my-companies-section').classList.remove('hidden');

      const html = companies.map(c => `
        <tr>
          <td>
            <div class="company-cell">
              <div class="company-icon">${c.logo || c.name?.charAt(0)}</div>
              <div>
                <div class="company-name">${c.name}</div>
                <div class="company-sector">${c.sector}</div>
              </div>
            </div>
          </td>
          <td><span class="badge ${getStageBadgeClass(c.stage)}">${c.stage}</span></td>
          <td class="text-right value">${formatCurrency(c.currentValuation)}</td>
          <td><span class="badge ${c.status === 'Active' ? 'badge-success' : 'badge-default'}">${c.status}</span></td>
        </tr>
      `).join('');

      document.getElementById('my-companies-table').innerHTML = html;
    }

    init();
  </script>
</body>
</html>
