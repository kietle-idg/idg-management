<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | IDGX Capital</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-inner">
        <a href="index.html" class="navbar-brand">
          <div class="navbar-logo">IDGX</div>
          <span>IDGX Capital</span>
        </a>
        
        <div class="navbar-nav">
          <a href="index.html" class="nav-link active">Dashboard</a>
          <a href="portfolio.html" class="nav-link" id="nav-portfolio">Portfolio</a>
          <a href="personal.html" class="nav-link">My View</a>
          <a href="documents.html" class="nav-link" id="nav-documents">Documents</a>
          <a href="admin.html" class="nav-link" id="nav-admin">Admin</a>
        </div>

        <div class="navbar-user">
          <div class="user-menu">
            <button class="user-button">
              <div class="user-avatar" id="user-avatar">--</div>
              <span id="user-name">Loading...</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div class="user-dropdown">
              <div class="dropdown-item" style="pointer-events: none; padding-bottom: 8px;">
                <small style="color: var(--text-muted);">Signed in as <span id="user-role-text">-</span></small>
              </div>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" onclick="Auth.signOut()">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="container container-lg">
        <!-- Page Header -->
        <div class="page-header">
          <h1 class="page-title">Fund Dashboard</h1>
          <p class="page-subtitle" id="page-subtitle">Overview of IDGX Capital Fund III</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading">
          <div class="spinner"></div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="hidden">
          <!-- Metrics - Full view for GP -->
          <div id="metrics-full" class="metrics">
            <div class="metric">
              <div class="metric-value" id="metric-aum">$0</div>
              <div class="metric-label">Total AUM</div>
            </div>
            <div class="metric">
              <div class="metric-value positive" id="metric-irr">0%</div>
              <div class="metric-label">Net IRR</div>
            </div>
            <div class="metric">
              <div class="metric-value positive" id="metric-moic">0x</div>
              <div class="metric-label">MOIC</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="metric-companies">0</div>
              <div class="metric-label">Portfolio Companies</div>
            </div>
          </div>

          <!-- Metrics - LP view -->
          <div id="metrics-lp" class="hidden">
            <div class="commitment-card">
              <div class="commitment-label">Your Commitment</div>
              <div class="commitment-value" id="lp-commitment">$0</div>
            </div>
            <div class="metrics" style="margin-bottom: 0;">
              <div class="metric">
                <div class="metric-value positive" id="lp-irr">0%</div>
                <div class="metric-label">Net IRR</div>
              </div>
              <div class="metric">
                <div class="metric-value positive" id="lp-moic">0x</div>
                <div class="metric-label">MOIC</div>
              </div>
            </div>
          </div>

          <!-- Capital Deployment -->
          <div id="capital-section" class="card mb-8">
            <div class="card-header">
              <h3 class="card-title">Capital Deployment</h3>
            </div>
            <div class="card-body">
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <div>
                  <span style="color: var(--text-muted);">Deployed</span>
                  <span class="font-semibold" id="capital-deployed" style="margin-left: 8px;">$0</span>
                </div>
                <div>
                  <span style="color: var(--text-muted);">Remaining</span>
                  <span class="font-semibold" id="capital-remaining" style="margin-left: 8px;">$0</span>
                </div>
              </div>
              <div class="progress">
                <div class="progress-bar" id="capital-progress" style="width: 0%"></div>
              </div>
              <div style="text-align: center; margin-top: 8px; color: var(--text-muted); font-size: 13px;" id="capital-percent">0% deployed</div>
            </div>
          </div>

          <!-- Two Column Layout -->
          <div class="grid-2">
            <!-- Top Companies -->
            <div id="companies-section" class="card">
              <div class="card-header">
                <h3 class="card-title">Top Companies</h3>
                <a href="portfolio.html" class="btn btn-ghost btn-sm">View all</a>
              </div>
              <div class="card-body no-padding">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Company</th>
                        <th class="text-right">Net Value</th>
                        <th>MOIC</th>
                      </tr>
                    </thead>
                    <tbody id="top-companies"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Upcoming Events -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Upcoming Events</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button class="btn btn-primary btn-sm" id="connect-calendar-btn" style="display: none;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Connect Calendar
                  </button>
                  <a href="personal.html" class="btn btn-ghost btn-sm">View all</a>
                </div>
              </div>
              <div class="card-body">
                <div id="calendar-loading" style="display: none; text-align: center; padding: 16px; color: var(--text-muted);">
                  <div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto 8px;"></div>
                  Loading calendar...
                </div>
                <ul class="list" id="upcoming-events"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="database.js"></script>
  <!-- Google API for Calendar -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <script>
    let fundData = null;
    let companiesData = [];
    let eventsData = [];

    async function init() {
      // Check authentication with timeout
      try {
        await Promise.race([
          Auth.init(),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Auth timeout')), 10000))
        ]);
      } catch (error) {
        console.error('Auth error:', error);
        window.location.href = 'login.html';
        return;
      }
      
      if (!Auth.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }

      const user = Auth.currentUserData;
      const role = user?.role || 'Admin';

      // Update navbar
      document.getElementById('user-name').textContent = user?.name || 'User';
      document.getElementById('user-avatar').textContent = user?.name?.split(' ').map(n => n[0]).join('') || '?';
      document.getElementById('user-role-text').textContent = role || '';

      // Show/hide nav items based on role
      if (role !== 'Admin') {
        document.getElementById('nav-admin').style.display = 'none';
      }
      if (role === 'LP') {
        document.getElementById('nav-portfolio').style.display = 'none';
      }

      // Load data from Firebase
      try {
        const timeout = ms => new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms));
        
        [fundData, companiesData] = await Promise.all([
          Promise.race([Database.getFund(), timeout(5000)]).catch(() => null),
          Promise.race([Database.getCompanies(), timeout(5000)]).catch(() => [])
        ]);
      } catch (error) {
        console.error('Data loading error:', error);
        fundData = null;
        companiesData = [];
      }

      // Initialize Google Calendar (client-side OAuth)
      initGoogleCalendar();

      // Role-based view
      if (role === 'LP') {
        document.getElementById('metrics-full').classList.add('hidden');
        document.getElementById('metrics-lp').classList.remove('hidden');
        document.getElementById('capital-section').classList.add('hidden');
        document.getElementById('companies-section').classList.add('hidden');
        document.getElementById('page-subtitle').textContent = 'Your investment overview';
        
        document.getElementById('lp-irr').textContent = formatPercent(fundData?.irr);
        document.getElementById('lp-moic').textContent = (fundData?.moic || 0).toFixed(2) + 'x';
        document.getElementById('lp-commitment').textContent = formatCurrency(user?.commitment || 0);
        
      } else if (role === 'Team') {
        document.getElementById('capital-section').classList.add('hidden');
        document.getElementById('companies-section').classList.add('hidden');
        document.getElementById('page-subtitle').textContent = 'Your team overview';
        
        renderMetrics();
      } else {
        // GP/Admin - full view
        renderMetrics();
        renderCapital();
        renderTopCompanies();
      }

      renderEvents();
      
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('dashboard-content').classList.remove('hidden');
    }

    // Formatting functions
    function formatCurrency(amount) {
      if (!amount) return '$0';
      if (amount >= 1000000000) return '$' + (amount / 1000000000).toFixed(1) + 'B';
      if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(1) + 'M';
      if (amount >= 1000) return '$' + (amount / 1000).toFixed(0) + 'K';
      return '$' + amount.toLocaleString();
    }

    function formatPercent(value) {
      return (value || 0).toFixed(1) + '%';
    }

    function formatDateShort(dateString) {
      if (!dateString) return { day: '--', month: '---' };
      const date = new Date(dateString);
      return {
        day: date.getDate(),
        month: date.toLocaleDateString('en-US', { month: 'short' })
      };
    }

    function getDaysUntil(dateString) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const target = new Date(dateString);
      target.setHours(0, 0, 0, 0);
      return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
    }

    function getStageBadgeClass(stage) {
      if (stage === 'Seed') return 'badge-warning';
      if (stage === 'Series A') return 'badge-success';
      if (stage === 'Series B') return 'badge-primary';
      if (stage === 'Exited') return 'badge-default';
      return 'badge-default';
    }

    // Same calculation logic as portfolio page
    function getCompanyMoic(c) {
      if (c.currentValuation > 0 && c.entryValuation > 0) return c.currentValuation / c.entryValuation;
      if (c.moic && c.moic > 0) return c.moic;
      return 0;
    }

    function getCompanyNetValue(c) {
      const moic = getCompanyMoic(c);
      if (moic > 0 && c.investmentAmount > 0) return Math.round(c.investmentAmount * moic);
      return 0;
    }

    function renderMetrics() {
      // AUM = sum of net values (Invested × MOIC for each company)
      const aum = companiesData.reduce((sum, c) => sum + getCompanyNetValue(c), 0);
      
      // Total invested
      const totalInvested = companiesData.reduce((sum, c) => sum + (c.investmentAmount || 0), 0);
      
      // Portfolio MOIC = total net value / total invested
      const moic = totalInvested > 0 ? aum / totalInvested : 0;
      
      // IRR from fund settings (complex to calculate, needs cash flow dates)
      const irr = fundData?.irr || null;
      
      document.getElementById('metric-aum').textContent = formatCurrency(aum);
      document.getElementById('metric-irr').textContent = irr !== null ? formatPercent(irr) : '--';
      document.getElementById('metric-moic').textContent = moic.toFixed(2) + 'x';
      document.getElementById('metric-companies').textContent = companiesData.length;
      
      // Also update LP view if applicable
      document.getElementById('lp-irr').textContent = irr !== null ? formatPercent(irr) : '--';
      document.getElementById('lp-moic').textContent = moic.toFixed(2) + 'x';
    }

    function renderCapital() {
      // Calculate deployed from portfolio data
      const deployed = companiesData.reduce((sum, c) => sum + (c.investmentAmount || 0), 0);
      const total = fundData?.fundSize || deployed || 1;
      const remaining = Math.max(0, total - deployed);
      const percent = Math.min(100, ((deployed / total) * 100)).toFixed(0);
      
      document.getElementById('capital-deployed').textContent = formatCurrency(deployed);
      document.getElementById('capital-remaining').textContent = formatCurrency(remaining);
      document.getElementById('capital-progress').style.width = percent + '%';
      document.getElementById('capital-percent').textContent = percent + '% deployed';
    }

    function renderTopCompanies() {
      const top = companiesData
        .filter(c => c.status === 'Active')
        .sort((a, b) => getCompanyNetValue(b) - getCompanyNetValue(a))
        .slice(0, 5);

      const html = top.map(c => {
        const moic = getCompanyMoic(c);
        const netVal = getCompanyNetValue(c);
        const moicColor = moic >= 1 ? 'var(--success)' : 'var(--danger)';
        return `
          <tr>
            <td>
              <div class="company-cell">
                <div class="company-icon">${c.logo || c.name?.charAt(0)}</div>
                <div>
                  <div class="company-name">${c.name}</div>
                  <div class="company-sector">${c.sector}</div>
                </div>
              </div>
            </td>
            <td class="text-right value">${formatCurrency(netVal)}</td>
            <td><span style="font-weight:600;color:${moicColor}">${moic > 0 ? moic.toFixed(2) + 'x' : '-'}</span></td>
          </tr>
        `;
      }).join('');

      document.getElementById('top-companies').innerHTML = html || '<tr><td colspan="3" class="text-center text-muted">No companies</td></tr>';
    }

    // ── Google Calendar (client-side OAuth) ──
    const CALENDAR_CLIENT_ID = '728812948064-2kdc14o4emgtn9ak4tioqme5d62ev6sa.apps.googleusercontent.com';
    const CALENDAR_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
    const DEAL_CALENDAR_ID = 'deal@idgcapitalvietnam.com';
    let tokenClient = null;
    let calendarAccessToken = null;

    function initGoogleCalendar() {
      // Show connect button
      const btn = document.getElementById('connect-calendar-btn');
      btn.style.display = 'inline-flex';
      btn.onclick = connectCalendar;

      // Wait for GIS library to load, then init token client
      const waitForGis = setInterval(() => {
        if (typeof google !== 'undefined' && google.accounts) {
          clearInterval(waitForGis);
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CALENDAR_CLIENT_ID,
            scope: CALENDAR_SCOPES,
            hint: DEAL_CALENDAR_ID,  // Pre-select deal@ account in the popup
            callback: (tokenResponse) => {
              if (tokenResponse && tokenResponse.access_token) {
                calendarAccessToken = tokenResponse.access_token;
                btn.style.display = 'none';
                fetchCalendarEvents();
              }
            },
            error_callback: (error) => {
              console.error('Calendar auth error:', error);
            }
          });
        }
      }, 200);

      // Show placeholder while waiting
      renderEvents();
    }

    function connectCalendar() {
      if (tokenClient) {
        tokenClient.requestAccessToken();
      }
    }

    async function fetchCalendarEvents() {
      const loadingEl = document.getElementById('calendar-loading');
      loadingEl.style.display = 'block';

      try {
        // Try deal@ calendar first, fall back to primary
        let calendarId = DEAL_CALENDAR_ID;
        let response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?` +
          new URLSearchParams({
            timeMin: new Date().toISOString(),
            showDeleted: 'false',
            singleEvents: 'true',
            maxResults: '10',
            orderBy: 'startTime'
          }), {
            headers: { 'Authorization': `Bearer ${calendarAccessToken}` }
          });

        // If deal@ calendar not accessible, try primary
        if (!response.ok) {
          console.warn('deal@ calendar not accessible, trying primary calendar');
          calendarId = 'primary';
          response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?` +
            new URLSearchParams({
              timeMin: new Date().toISOString(),
              showDeleted: 'false',
              singleEvents: 'true',
              maxResults: '10',
              orderBy: 'startTime'
            }), {
              headers: { 'Authorization': `Bearer ${calendarAccessToken}` }
            });
        }

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error?.message || `API error ${response.status}`);
        }

        const data = await response.json();
        eventsData = (data.items || []).map(event => {
          const start = event.start.dateTime || event.start.date;
          const isAllDay = !event.start.dateTime;
          const startDate = new Date(start);
          return {
            title: event.summary || '(No title)',
            date: isAllDay ? event.start.date : startDate.toISOString().split('T')[0],
            time: isAllDay ? 'All Day' : startDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            location: event.location || '',
            type: 'Calendar'
          };
        });

        renderEvents();
      } catch (error) {
        console.error('Calendar fetch error:', error);
        document.getElementById('upcoming-events').innerHTML =
          '<li class="empty-state" style="padding: 24px;"><p style="color: var(--danger);">Error loading calendar: ' + error.message + '</p></li>';
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    function renderEvents() {
      let events = (eventsData || [])
        .filter(e => e.date && getDaysUntil(e.date) >= 0)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5);

      const html = events.map(e => {
        const d = formatDateShort(e.date);
        const location = e.location ? ` · ${e.location}` : '';
        return `
          <li class="list-item">
            <div class="event-date">
              <div class="event-day">${d.day}</div>
              <div class="event-month">${d.month}</div>
            </div>
            <div class="event-content">
              <div class="event-title">${e.title}</div>
              <div class="event-meta">${e.time || ''}${location}</div>
            </div>
          </li>
        `;
      }).join('');

      if (html) {
        document.getElementById('upcoming-events').innerHTML = html;
      } else if (!calendarAccessToken) {
        document.getElementById('upcoming-events').innerHTML =
          '<li class="empty-state" style="padding: 24px;"><p>Click "Connect Calendar" to see upcoming events from deal@idgcapitalvietnam.com</p></li>';
      } else {
        document.getElementById('upcoming-events').innerHTML =
          '<li class="empty-state" style="padding: 24px;"><p>No upcoming events</p></li>';
      }
    }

    init();
  </script>
</body>
</html>
