<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio | IDGX Capital</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-inner">
        <a href="index.html" class="navbar-brand">
          <div class="navbar-logo">IDGX</div>
          <span>IDGX Capital</span>
        </a>
        
        <div class="navbar-nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="portfolio.html" class="nav-link active" id="nav-portfolio">Portfolio</a>
          <a href="personal.html" class="nav-link">My View</a>
          <a href="documents.html" class="nav-link" id="nav-documents">Documents</a>
          <a href="admin.html" class="nav-link" id="nav-admin">Admin</a>
        </div>

        <div class="navbar-user">
          <div class="user-menu">
            <button class="user-button">
              <div class="user-avatar" id="user-avatar">--</div>
              <span id="user-name">Loading...</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div class="user-dropdown">
              <div class="dropdown-item" style="pointer-events: none; padding-bottom: 8px;">
                <small style="color: var(--text-muted);">Signed in as <span id="user-role-text">-</span></small>
              </div>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" onclick="Auth.signOut()">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="container container-lg">
        <!-- Page Header -->
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h1 class="page-title">Portfolio Companies</h1>
            <p class="page-subtitle">All investments in IDGX Capital Fund I</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="aiSync()" id="ai-sync-btn" style="display: none;">
              <span style="margin-right: 4px;">ü§ñ</span>
              <span id="ai-sync-text">AI Sync</span>
            </button>
            <button class="btn btn-secondary" onclick="refreshCryptoPrices()" id="crypto-prices-btn" style="display: none;">
              <span style="margin-right: 4px;">üìà</span>
              <span id="crypto-prices-text">Refresh Crypto Prices</span>
            </button>
            <button class="btn btn-secondary" onclick="syncFromSheets()" id="sync-sheets-btn" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8V3"></path>
              </svg>
              <span id="sync-sheets-text">Sync from Sheets</span>
            </button>
            <button class="btn btn-primary" onclick="showAddCompanyModal()" id="add-company-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Company
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading">
          <div class="spinner"></div>
        </div>

        <!-- Portfolio Content -->
        <div id="portfolio-content" class="hidden">
          <!-- Summary Stats -->
          <div class="metrics mb-8">
            <div class="metric">
              <div class="metric-value" id="total-companies">0</div>
              <div class="metric-label">Total Companies</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="active-companies">0</div>
              <div class="metric-label">Active</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="total-invested">$0</div>
              <div class="metric-label">Capital Deployed</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="unrealized-value">$0</div>
              <div class="metric-label">Unrealized Value</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="realized-value">$0</div>
              <div class="metric-label">Realized Value</div>
            </div>
            <div class="metric">
              <div class="metric-value positive" id="fund-moic">0x</div>
              <div class="metric-label">Fund MOIC (TVPI)</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="card mb-6">
            <div class="card-body" style="padding: 16px 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div class="filters">
                  <button class="filter-btn active" data-filter="all">All</button>
                  <button class="filter-btn" data-filter="active">Active</button>
                  <button class="filter-btn" data-filter="partial">Partially Exited</button>
                  <button class="filter-btn" data-filter="exited">Exited</button>
                </div>
                <div class="search-box" style="min-width: 280px;">
                  <span class="search-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                  </span>
                  <input type="text" class="search-input" id="search-input" placeholder="Search companies, sectors...">
                </div>
              </div>
            </div>
          </div>

          <!-- Portfolio Table -->
          <div class="card">
            <div class="card-body no-padding">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Company</th>
                      <th>Stage</th>
                      <th class="text-right">Invested</th>
                      <th class="text-right">Entry Valuation</th>
                      <th class="text-right">Current Valuation</th>
                      <th class="text-right">Ownership</th>
                      <th class="text-right">Net Value</th>
                      <th class="text-right">MOIC</th>
                      <th>Status</th>
                      <th class="text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="portfolio-table"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Export Buttons -->
          <div class="mt-6" style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="exportToPDF()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              Export PDF
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              Export Excel
            </button>
          </div>
        </div>
      </div>
    </main>
    <!-- Add Company Modal -->
    <div class="modal-overlay" id="add-company-modal">
      <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title">Add New Company</h3>
          <button class="modal-close" onclick="hideAddCompanyModal()">&times;</button>
        </div>
        <div class="modal-body">
          <form id="add-company-form">
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Company Name *</label>
                <input type="text" class="form-input" id="company-name" required>
              </div>
              <div class="form-group">
                <label class="form-label">Sector *</label>
                <input type="text" class="form-input" id="company-sector" placeholder="e.g. FinTech, Healthcare" required>
              </div>
              <div class="form-group">
                <label class="form-label">Stage *</label>
                <select class="form-input form-select" id="company-stage" required>
                  <option value="Seed">Seed</option>
                  <option value="Series A">Series A</option>
                  <option value="Series B">Series B</option>
                  <option value="Series C">Series C</option>
                  <option value="Growth">Growth</option>
                  <option value="Exited">Exited</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Status *</label>
                <select class="form-input form-select" id="company-status" required onchange="toggleAddExitFields()">
                  <option value="Active">Active</option>
                  <option value="Partially Exited">Partially Exited</option>
                  <option value="Exited">Exited</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Investment Date</label>
                <input type="date" class="form-input" id="company-date">
              </div>
              <div class="form-group">
                <label class="form-label">Investment Amount ($)</label>
                <input type="number" class="form-input" id="company-investment" placeholder="5000000">
              </div>
              <div class="form-group">
                <label class="form-label">Valuation at Entry ($)</label>
                <input type="number" class="form-input" id="company-entry-valuation" placeholder="10000000">
              </div>
              <div class="form-group">
                <label class="form-label">Current Valuation ($)</label>
                <input type="number" class="form-input" id="company-valuation" placeholder="25000000">
              </div>
              <div class="form-group">
                <label class="form-label">Ownership (%)</label>
                <input type="number" step="0.001" class="form-input" id="company-ownership" placeholder="15.5">
              </div>
              <div class="form-group">
                <label class="form-label">CoinGecko ID</label>
                <input type="text" class="form-input" id="company-coingecko-id" placeholder="e.g. bitcoin, sei-network">
              </div>
              <!-- Exit fields (shown/hidden by JS) -->
              <div id="add-exit-fields" style="display:none;grid-column:span 2;">
                <div class="grid-2">
                  <div class="form-group" id="add-exit-date-group">
                    <label class="form-label">Exit Date</label>
                    <input type="date" class="form-input" id="company-exit-date">
                  </div>
                  <div class="form-group" id="add-exit-proceeds-group">
                    <label class="form-label">Exit Proceeds ($)</label>
                    <input type="number" class="form-input" id="company-exit-proceeds" placeholder="Total cash received">
                  </div>
                </div>
              </div>
              <div id="add-partial-exit-fields" style="display:none;grid-column:span 2;">
                <div class="grid-2">
                  <div class="form-group">
                    <label class="form-label">Partial Exit Date</label>
                    <input type="date" class="form-input" id="company-partial-exit-date">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Amount Realized ($)</label>
                    <input type="number" class="form-input" id="company-amount-realized" placeholder="Cash received from partial sales">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Remaining Ownership (%)</label>
                    <input type="number" step="0.001" class="form-input" id="company-remaining-ownership" placeholder="Ownership still held">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Remaining Cost Basis ($)</label>
                    <input type="number" class="form-input" id="company-remaining-cost-basis" placeholder="Cost basis of remaining position">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Founder Name</label>
                <input type="text" class="form-input" id="company-founder">
              </div>
              <div class="form-group">
                <label class="form-label">Founder Email</label>
                <input type="email" class="form-input" id="company-founder-email">
              </div>
              <div class="form-group" style="grid-column: span 2;">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="company-location" placeholder="San Francisco, CA">
              </div>
              <div class="form-group" style="grid-column: span 2;">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="company-description" placeholder="Brief description of the company">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideAddCompanyModal()">Cancel</button>
          <button class="btn btn-primary" onclick="addCompany()">Add Company</button>
        </div>
      </div>
    </div>

    <!-- Edit Company Modal -->
    <div class="modal-overlay" id="edit-company-modal">
      <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title">Edit Company</h3>
          <button class="modal-close" onclick="hideEditCompanyModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-company-id">
          <div class="grid-2">
            <div class="form-group">
              <label class="form-label">Company Name *</label>
              <input type="text" class="form-input" id="edit-company-name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Sector *</label>
              <input type="text" class="form-input" id="edit-company-sector" required>
            </div>
            <div class="form-group">
              <label class="form-label">Stage *</label>
              <select class="form-input form-select" id="edit-company-stage" required>
                <option value="Seed">Seed</option>
                <option value="Series A">Series A</option>
                <option value="Series B">Series B</option>
                <option value="Series C">Series C</option>
                <option value="Growth">Growth</option>
                <option value="Exited">Exited</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status *</label>
              <select class="form-input form-select" id="edit-company-status" required onchange="toggleEditExitFields()">
                <option value="Active">Active</option>
                <option value="Partially Exited">Partially Exited</option>
                <option value="Exited">Exited</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Investment Date</label>
              <input type="date" class="form-input" id="edit-company-date">
            </div>
            <div class="form-group">
              <label class="form-label">Investment Amount ($)</label>
              <input type="number" class="form-input" id="edit-company-investment">
            </div>
            <div class="form-group">
              <label class="form-label">Valuation at Entry ($)</label>
              <input type="number" class="form-input" id="edit-company-entry-valuation">
            </div>
            <div class="form-group">
              <label class="form-label">Current Valuation ($)</label>
              <input type="number" class="form-input" id="edit-company-valuation">
            </div>
            <div class="form-group">
              <label class="form-label">Ownership (%)</label>
              <input type="number" step="0.001" class="form-input" id="edit-company-ownership">
            </div>
            <div class="form-group">
              <label class="form-label">CoinGecko ID</label>
              <input type="text" class="form-input" id="edit-company-coingecko-id" placeholder="e.g. bitcoin, sei-network">
            </div>
            <!-- Exit fields (shown/hidden by JS) -->
            <div id="edit-exit-fields" style="display:none;grid-column:span 2;">
              <div class="grid-2">
                <div class="form-group">
                  <label class="form-label">Exit Date</label>
                  <input type="date" class="form-input" id="edit-company-exit-date">
                </div>
                <div class="form-group">
                  <label class="form-label">Exit Proceeds ($)</label>
                  <input type="number" class="form-input" id="edit-company-exit-proceeds" placeholder="Total cash received">
                </div>
              </div>
            </div>
            <div id="edit-partial-exit-fields" style="display:none;grid-column:span 2;">
              <div class="grid-2">
                <div class="form-group">
                  <label class="form-label">Partial Exit Date</label>
                  <input type="date" class="form-input" id="edit-company-partial-exit-date">
                </div>
                <div class="form-group">
                  <label class="form-label">Amount Realized ($)</label>
                  <input type="number" class="form-input" id="edit-company-amount-realized" placeholder="Cash received from partial sales">
                </div>
                <div class="form-group">
                  <label class="form-label">Remaining Ownership (%)</label>
                  <input type="number" step="0.001" class="form-input" id="edit-company-remaining-ownership" placeholder="Ownership still held">
                </div>
                <div class="form-group">
                  <label class="form-label">Remaining Cost Basis ($)</label>
                  <input type="number" class="form-input" id="edit-company-remaining-cost-basis" placeholder="Cost basis of remaining position">
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Founder Name</label>
              <input type="text" class="form-input" id="edit-company-founder">
            </div>
            <div class="form-group">
              <label class="form-label">Founder Email</label>
              <input type="email" class="form-input" id="edit-company-founder-email">
            </div>
            <div class="form-group" style="grid-column: span 2;">
              <label class="form-label">Location</label>
              <input type="text" class="form-input" id="edit-company-location">
            </div>
            <div class="form-group" style="grid-column: span 2;">
              <label class="form-label">Description</label>
              <input type="text" class="form-input" id="edit-company-description">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideEditCompanyModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveCompanyEdit()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="database.js"></script>
  <script src="chat-widget.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    let currentFilter = 'all';
    let currentSearch = '';
    let companiesData = [];
    let fundData = null;

    async function init() {
      // Check authentication
      await Auth.init();
      
      if (!Auth.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }

      const user = Auth.currentUserData;
      const role = user?.role;

      // Update navbar
      document.getElementById('user-name').textContent = user?.name || 'User';
      document.getElementById('user-avatar').textContent = user?.name?.split(' ').map(n => n[0]).join('') || '?';
      document.getElementById('user-role-text').textContent = role || '';

      // Show/hide nav items based on role
      if (role !== 'Admin') {
        document.getElementById('nav-admin').style.display = 'none';
      }
      
      // LP cannot view portfolio
      if (role === 'LP') {
        window.location.href = 'index.html';
        return;
      }

      // Only Admin and Team can add/edit companies; Admin can sync
      if (role !== 'Admin' && role !== 'Team') {
        document.getElementById('add-company-btn').style.display = 'none';
      }
      if (role === 'Admin') {
        document.getElementById('sync-sheets-btn').style.display = 'inline-flex';
        document.getElementById('ai-sync-btn').style.display = 'inline-flex';
      }
      if (role === 'Admin' || role === 'Team') {
        document.getElementById('crypto-prices-btn').style.display = 'inline-flex';
      }

      // Load companies and fund data from Firebase
      companiesData = await Database.getCompanies();
      fundData = await Database.getFund();

      renderSummary();
      renderTable();
      setupFilters();
      
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('portfolio-content').classList.remove('hidden');
    }

    // Formatting functions
    function formatCurrency(amount) {
      if (!amount) return '$0';
      if (amount >= 1000000000) return '$' + (amount / 1000000000).toFixed(1) + 'B';
      if (amount >= 1000000) return '$' + (amount / 1000000).toFixed(1) + 'M';
      if (amount >= 1000) return '$' + (amount / 1000).toFixed(0) + 'K';
      return '$' + amount.toLocaleString();
    }

    function getMoic(c) {
      if (c.status === 'Exited') {
        // Exited: MOIC = exit proceeds / investment amount
        if (c.exitProceeds > 0 && c.investmentAmount > 0) return c.exitProceeds / c.investmentAmount;
        return 0;
      }
      if (c.status === 'Partially Exited') {
        // Partially Exited: MOIC = (amountRealized + unrealized remaining) / investmentAmount
        const baseMoic = (c.currentValuation > 0 && c.entryValuation > 0) ? c.currentValuation / c.entryValuation : (c.moic || 0);
        const unrealized = (c.remainingCostBasis || 0) * baseMoic;
        const total = (c.amountRealized || 0) + unrealized;
        if (c.investmentAmount > 0) return total / c.investmentAmount;
        return 0;
      }
      // Active: current valuation / entry valuation
      if (c.currentValuation > 0 && c.entryValuation > 0) return c.currentValuation / c.entryValuation;
      if (c.moic && c.moic > 0) return c.moic;
      return 0;
    }

    function getUnrealizedValue(c) {
      if (c.status === 'Exited') return 0;
      if (c.status === 'Partially Exited') {
        // Unrealized = remainingCostBasis √ó valuation MOIC
        const baseMoic = (c.currentValuation > 0 && c.entryValuation > 0) ? c.currentValuation / c.entryValuation : (c.moic || 0);
        return Math.round((c.remainingCostBasis || 0) * (baseMoic > 0 ? baseMoic : 1));
      }
      // Active: invested √ó MOIC
      const moic = getMoic(c);
      if (moic > 0 && c.investmentAmount > 0) return Math.round(c.investmentAmount * moic);
      return 0;
    }

    function getRealizedValue(c) {
      if (c.status === 'Exited') return c.exitProceeds || 0;
      if (c.status === 'Partially Exited') return c.amountRealized || 0;
      return 0;
    }

    function getNetValue(c) {
      return getUnrealizedValue(c) + getRealizedValue(c);
    }

    function formatMoic(c) {
      const moic = getMoic(c);
      return moic > 0 ? moic.toFixed(2) + 'x' : '-';
    }

    function getMoicColor(c) {
      const moic = getMoic(c);
      if (moic === 0) return 'var(--text-muted)';
      return moic >= 1 ? 'var(--success)' : 'var(--danger)';
    }

    function getStatusBadgeClass(status) {
      if (status === 'Active') return 'badge-success';
      if (status === 'Partially Exited') return 'badge-warning';
      return 'badge-default';
    }

    function getStageBadgeClass(stage) {
      if (stage === 'Seed') return 'badge-warning';
      if (stage === 'Series A') return 'badge-success';
      if (stage === 'Series B') return 'badge-primary';
      if (stage === 'Exited') return 'badge-default';
      return 'badge-default';
    }

    function renderSummary() {
      let companies = companiesData;

      const active = companies.filter(c => c.status === 'Active' || c.status === 'Partially Exited');
      // Only count Active + Partially Exited (exited capital was recycled/redeployed)
      const totalInvested = companies
        .filter(c => c.status === 'Active' || c.status === 'Partially Exited')
        .reduce((sum, c) => sum + (c.investmentAmount || 0), 0);
      const unrealized = companies.reduce((sum, c) => sum + getUnrealizedValue(c), 0);
      const realized = companies.reduce((sum, c) => sum + getRealizedValue(c), 0);
      // MOIC denominator = capital deployed (Active + Partially Exited only, excludes recycled)
      const totalValue = unrealized + realized;
      const moic = totalInvested > 0 ? totalValue / totalInvested : 0;

      document.getElementById('total-companies').textContent = companies.length;
      document.getElementById('active-companies').textContent = active.length;
      document.getElementById('total-invested').textContent = formatCurrency(totalInvested);
      document.getElementById('unrealized-value').textContent = formatCurrency(unrealized);
      document.getElementById('realized-value').textContent = formatCurrency(realized);
      document.getElementById('fund-moic').textContent = moic.toFixed(2) + 'x';
    }

    function renderTable() {
      let companies = [...companiesData];

      // Apply filter
      if (currentFilter === 'active') {
        companies = companies.filter(c => c.status === 'Active');
      } else if (currentFilter === 'partial') {
        companies = companies.filter(c => c.status === 'Partially Exited');
      } else if (currentFilter === 'exited') {
        companies = companies.filter(c => c.status === 'Exited');
      }

      // Apply search
      if (currentSearch) {
        const s = currentSearch.toLowerCase();
        companies = companies.filter(c => 
          c.name?.toLowerCase().includes(s) ||
          c.sector?.toLowerCase().includes(s) ||
          c.founder?.toLowerCase().includes(s)
        );
      }

      // Sort by MOIC (highest first)
      companies.sort((a, b) => getMoic(b) - getMoic(a));

      const canEdit = Auth.currentUserData?.role === 'Admin' || Auth.currentUserData?.role === 'Team';
      
      const html = companies.map(c => {
        const hasDetails = c.description || c.aiUpdates?.length || c.aiHighlights?.length;
        const updatesHtml = (c.aiUpdates || []).map(u => `<li style="margin-bottom: 4px;">${u}</li>`).join('');
        const highlightsHtml = (c.aiHighlights || []).map(h => `<li style="margin-bottom: 4px;">${h}</li>`).join('');
        const metricsHtml = c.aiKeyMetrics ? Object.entries(c.aiKeyMetrics).map(([k,v]) => `<span style="display:inline-block;background:var(--bg-secondary);padding:4px 10px;border-radius:6px;margin:2px 4px 2px 0;font-size:12px;"><strong>${k}:</strong> ${v}</span>`).join('') : '';

        return `
        <tr>
          <td>
            <div class="company-cell">
              <div class="company-icon">${c.logo || c.name?.charAt(0)}</div>
              <div>
                <div class="company-name" style="cursor:pointer;" onclick="toggleDetail('${c.id}')">
                  ${c.name}
                  ${c.coingeckoId ? '<span style="display:inline-block;background:var(--accent-light);color:var(--accent);font-size:10px;font-weight:600;padding:1px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;">LISTED</span>' : ''}
                  ${hasDetails ? '<span style="font-size:11px;color:var(--text-muted);margin-left:4px;">‚ñ∏</span>' : ''}
                </div>
                <div class="company-sector">${c.sector}${c.coingeckoId && c.tokenPrice ? ` ¬∑ $${c.tokenPrice < 0.01 ? c.tokenPrice.toFixed(6) : c.tokenPrice < 1 ? c.tokenPrice.toFixed(4) : c.tokenPrice.toFixed(2)}` : ''}${c.coingeckoId && c.priceChange24h != null ? ` <span style="color:${c.priceChange24h >= 0 ? 'var(--success)' : 'var(--danger)'};font-size:11px;">${c.priceChange24h >= 0 ? '+' : ''}${c.priceChange24h.toFixed(1)}%</span>` : ''}</div>
              </div>
            </div>
          </td>
          <td><span class="badge ${getStageBadgeClass(c.stage)}">${c.stage}</span></td>
          <td class="text-right value">${formatCurrency(c.investmentAmount)}</td>
          <td class="text-right value">${formatCurrency(c.entryValuation)}</td>
          <td class="text-right value">${formatCurrency(c.currentValuation)}</td>
          <td class="text-right">${(c.ownership || 0).toFixed(3)}%</td>
          <td class="text-right value">
            ${formatCurrency(getUnrealizedValue(c))}
            ${getRealizedValue(c) > 0 ? `<div style="font-size:11px;color:var(--text-muted);">(+${formatCurrency(getRealizedValue(c))} realized)</div>` : ''}
          </td>
          <td class="text-right" style="font-weight: 600; color: ${getMoicColor(c)};">${formatMoic(c)}</td>
          <td><span class="badge ${getStatusBadgeClass(c.status)}">${c.status}</span></td>
          <td class="text-right">
            ${canEdit ? `
              <button class="btn btn-ghost btn-sm" onclick="editCompany('${c.id}')">Edit</button>
              <button class="btn btn-ghost btn-sm" style="color: var(--danger);" onclick="deleteCompany('${c.id}', '${c.name?.replace(/'/g, "\\'")}')">Delete</button>
            ` : '-'}
          </td>
        </tr>
        <tr class="detail-row" id="detail-${c.id}" style="display:none;">
          <td colspan="10" style="padding:0;border-top:none;">
            <div style="padding:20px 24px;background:var(--bg-secondary);border-bottom:2px solid var(--primary);">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
                <div>
                  <h4 style="margin:0 0 8px;font-size:14px;color:var(--text-primary);">üìã About</h4>
                  <p style="color:var(--text-secondary);line-height:1.6;font-size:13px;margin:0;">
                    ${c.description || '<em style="color:var(--text-muted);">No description yet. Run AI Sync to extract info from documents.</em>'}
                  </p>
                  ${highlightsHtml ? `
                    <h4 style="margin:16px 0 8px;font-size:14px;color:var(--text-primary);">‚≠ê Highlights</h4>
                    <ul style="color:var(--text-secondary);padding-left:20px;font-size:13px;margin:0;">${highlightsHtml}</ul>
                  ` : ''}
                  ${metricsHtml ? `
                    <h4 style="margin:16px 0 8px;font-size:14px;color:var(--text-primary);">üìä Key Metrics</h4>
                    <div>${metricsHtml}</div>
                  ` : ''}
                </div>
                <div>
                  ${updatesHtml ? `
                    <h4 style="margin:0 0 8px;font-size:14px;color:var(--text-primary);">üì∞ Latest Updates</h4>
                    <ul style="color:var(--text-secondary);padding-left:20px;font-size:13px;margin:0;">${updatesHtml}</ul>
                  ` : '<p style="color:var(--text-muted);font-size:13px;margin:0;"><em>No updates yet. Run AI Sync to extract from documents.</em></p>'}
                  <div style="margin-top:16px;">
                    ${c.founder ? `<p style="font-size:13px;margin:0 0 4px;"><strong>Founder:</strong> <span style="color:var(--text-secondary);">${c.founder}</span></p>` : ''}
                    ${c.location ? `<p style="font-size:13px;margin:0 0 4px;"><strong>Location:</strong> <span style="color:var(--text-secondary);">${c.location}</span></p>` : ''}
                    ${c.investors ? `<p style="font-size:13px;margin:0 0 4px;"><strong>Investors:</strong> <span style="color:var(--text-secondary);">${c.investors}</span></p>` : ''}
                  </div>
                  ${c.lastAiSync ? `
                    <p style="margin-top:16px;font-size:11px;color:var(--text-muted);">ü§ñ Last AI sync: ${new Date(c.lastAiSync).toLocaleString()}</p>
                  ` : ''}
                </div>
              </div>
            </div>
          </td>
        </tr>
        `;
      }).join('');

      document.getElementById('portfolio-table').innerHTML = html || '<tr><td colspan="10" class="text-center text-muted" style="padding: 48px;">No companies found</td></tr>';
    }

    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderTable();
        });
      });

      document.getElementById('search-input').addEventListener('input', (e) => {
        currentSearch = e.target.value;
        renderTable();
      });
    }

    // Export functions
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('IDGX Capital - Portfolio Companies', 14, 22);
      doc.setFontSize(10);
      doc.text('Generated: ' + new Date().toLocaleDateString(), 14, 30);

      const tableData = companiesData.map(c => [
        c.name,
        c.stage,
        formatCurrency(c.investmentAmount),
        formatCurrency(c.entryValuation),
        formatCurrency(c.currentValuation),
        (c.ownership || 0).toFixed(1) + '%',
        c.moic ? c.moic.toFixed(2) + 'x' : '-',
        c.status
      ]);

      doc.autoTable({
        head: [['Company', 'Stage', 'Invested', 'Entry Valuation', 'Current Valuation', 'Ownership', 'MOIC', 'Status']],
        body: tableData,
        startY: 40,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [124, 58, 237] }
      });

      doc.save('idg-portfolio.pdf');
    }

    function exportToExcel() {
      const data = companiesData.map(c => ({
        'Company': c.name,
        'Sector': c.sector,
        'Stage': c.stage,
        'Investment Date': c.investmentDate,
        'Invested': c.investmentAmount,
        'Entry Valuation': c.entryValuation,
        'Current Valuation': c.currentValuation,
        'Ownership %': c.ownership,
        'MOIC': c.moic ? c.moic.toFixed(2) + 'x' : '-',
        'Net Value': c.netValue,
        'Status': c.status,
        'Investors': c.investors,
        'Location': c.location
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Portfolio');
      XLSX.writeFile(wb, 'idg-portfolio.xlsx');
    }

    // Toast notification
    function showToast(message, isError = false) {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 24px;
        background: ${isError ? '#EF4444' : '#10B981'};
        color: white;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Add Company Modal
    function showAddCompanyModal() {
      document.getElementById('add-company-form').reset();
      document.getElementById('add-company-modal').classList.add('visible');
    }

    function hideAddCompanyModal() {
      document.getElementById('add-company-modal').classList.remove('visible');
    }

    // Toggle exit fields in Add modal
    function toggleAddExitFields() {
      const status = document.getElementById('company-status').value;
      document.getElementById('add-exit-fields').style.display = status === 'Exited' ? 'block' : 'none';
      document.getElementById('add-partial-exit-fields').style.display = status === 'Partially Exited' ? 'block' : 'none';
    }

    // Toggle exit fields in Edit modal
    function toggleEditExitFields() {
      const status = document.getElementById('edit-company-status').value;
      document.getElementById('edit-exit-fields').style.display = status === 'Exited' ? 'block' : 'none';
      document.getElementById('edit-partial-exit-fields').style.display = status === 'Partially Exited' ? 'block' : 'none';
    }

    async function addCompany() {
      const name = document.getElementById('company-name').value;
      const sector = document.getElementById('company-sector').value;
      const stage = document.getElementById('company-stage').value;
      const status = document.getElementById('company-status').value;

      if (!name || !sector) {
        showToast('Company name and sector are required', true);
        return;
      }

      const investmentAmount = parseInt(document.getElementById('company-investment').value) || 0;
      const entryValuation = parseInt(document.getElementById('company-entry-valuation').value) || 0;
      const currentValuation = parseInt(document.getElementById('company-valuation').value) || 0;

      const companyData = {
        name,
        sector,
        stage,
        status,
        investmentDate: document.getElementById('company-date').value || null,
        investmentAmount,
        entryValuation,
        currentValuation,
        ownership: parseFloat(document.getElementById('company-ownership').value) || 0,
        founder: document.getElementById('company-founder').value || null,
        founderEmail: document.getElementById('company-founder-email').value || null,
        location: document.getElementById('company-location').value || null,
        description: document.getElementById('company-description').value || null,
        coingeckoId: document.getElementById('company-coingecko-id').value.trim().toLowerCase() || null
      };

      // Exit fields
      if (status === 'Exited') {
        companyData.exitDate = document.getElementById('company-exit-date').value || null;
        companyData.exitProceeds = parseInt(document.getElementById('company-exit-proceeds').value) || 0;
        if (companyData.exitProceeds > 0 && investmentAmount > 0) {
          companyData.moic = companyData.exitProceeds / investmentAmount;
        }
      } else if (status === 'Partially Exited') {
        companyData.partialExitDate = document.getElementById('company-partial-exit-date').value || null;
        companyData.amountRealized = parseInt(document.getElementById('company-amount-realized').value) || 0;
        companyData.remainingOwnership = parseFloat(document.getElementById('company-remaining-ownership').value) || 0;
        companyData.remainingCostBasis = parseInt(document.getElementById('company-remaining-cost-basis').value) || 0;
      }

      // Auto-calculate MOIC for active
      if (status === 'Active' && currentValuation > 0 && entryValuation > 0) {
        companyData.moic = currentValuation / entryValuation;
        companyData.netValue = Math.round(investmentAmount * companyData.moic);
      }

      const result = await Database.createCompany(companyData);
      
      if (result.success) {
        hideAddCompanyModal();
        companiesData = await Database.getCompanies();
        renderSummary();
        renderTable();
        showToast('Company added successfully!');
      } else {
        showToast('Error adding company', true);
      }
    }

    // Edit Company Modal
    function editCompany(companyId) {
      const company = companiesData.find(c => c.id === companyId);
      if (!company) return;

      document.getElementById('edit-company-id').value = companyId;
      document.getElementById('edit-company-name').value = company.name || '';
      document.getElementById('edit-company-sector').value = company.sector || '';
      document.getElementById('edit-company-stage').value = company.stage || 'Seed';
      document.getElementById('edit-company-status').value = company.status || 'Active';
      document.getElementById('edit-company-date').value = company.investmentDate || '';
      document.getElementById('edit-company-investment').value = company.investmentAmount || '';
      document.getElementById('edit-company-entry-valuation').value = company.entryValuation || '';
      document.getElementById('edit-company-valuation').value = company.currentValuation || '';
      document.getElementById('edit-company-ownership').value = company.ownership || '';
      document.getElementById('edit-company-founder').value = company.founder || '';
      document.getElementById('edit-company-founder-email').value = company.founderEmail || '';
      document.getElementById('edit-company-location').value = company.location || '';
      document.getElementById('edit-company-description').value = company.description || '';
      document.getElementById('edit-company-coingecko-id').value = company.coingeckoId || '';

      // Populate exit fields
      document.getElementById('edit-company-exit-date').value = company.exitDate || '';
      document.getElementById('edit-company-exit-proceeds').value = company.exitProceeds || '';
      document.getElementById('edit-company-partial-exit-date').value = company.partialExitDate || '';
      document.getElementById('edit-company-amount-realized').value = company.amountRealized || '';
      document.getElementById('edit-company-remaining-ownership').value = company.remainingOwnership || '';
      document.getElementById('edit-company-remaining-cost-basis').value = company.remainingCostBasis || '';

      // Show/hide exit fields based on status
      toggleEditExitFields();

      document.getElementById('edit-company-modal').classList.add('visible');
    }

    function hideEditCompanyModal() {
      document.getElementById('edit-company-modal').classList.remove('visible');
    }

    async function saveCompanyEdit() {
      const companyId = document.getElementById('edit-company-id').value;
      const company = companiesData.find(c => c.id === companyId);
      const name = document.getElementById('edit-company-name').value;
      const sector = document.getElementById('edit-company-sector').value;
      const status = document.getElementById('edit-company-status').value;

      if (!name || !sector) {
        showToast('Company name and sector are required', true);
        return;
      }

      const investmentAmount = parseInt(document.getElementById('edit-company-investment').value) || 0;
      const entryValuation = parseInt(document.getElementById('edit-company-entry-valuation').value) || 0;
      const currentValuation = parseInt(document.getElementById('edit-company-valuation').value) || 0;
      const ownership = parseFloat(document.getElementById('edit-company-ownership').value) || 0;
      const founder = document.getElementById('edit-company-founder').value || null;
      const location = document.getElementById('edit-company-location').value || null;
      const description = document.getElementById('edit-company-description').value || null;

      // Auto-calculate MOIC based on status
      let moic = 0;
      let netValue = 0;

      if (status === 'Exited') {
        const exitProceeds = parseInt(document.getElementById('edit-company-exit-proceeds').value) || 0;
        if (exitProceeds > 0 && investmentAmount > 0) moic = exitProceeds / investmentAmount;
        netValue = exitProceeds;
      } else if (status === 'Partially Exited') {
        const amountRealized = parseInt(document.getElementById('edit-company-amount-realized').value) || 0;
        const remainingCostBasis = parseInt(document.getElementById('edit-company-remaining-cost-basis').value) || 0;
        const baseMoic = (currentValuation > 0 && entryValuation > 0) ? currentValuation / entryValuation : 0;
        const unrealized = remainingCostBasis * (baseMoic > 0 ? baseMoic : 1);
        if (investmentAmount > 0) moic = (amountRealized + unrealized) / investmentAmount;
        netValue = Math.round(amountRealized + unrealized);
      } else {
        // Active
        if (currentValuation > 0 && entryValuation > 0) moic = currentValuation / entryValuation;
        if (moic > 0 && investmentAmount > 0) netValue = Math.round(investmentAmount * moic);
      }

      // Track which fields user manually changed (so AI won't overwrite them)
      const manualFields = new Set(company?.manualFields || []);
      if (name !== (company?.name || '')) manualFields.add('name');
      if (sector !== (company?.sector || '')) manualFields.add('sector');
      if (document.getElementById('edit-company-stage').value !== (company?.stage || '')) manualFields.add('stage');
      if (description !== (company?.description || '')) manualFields.add('description');
      if (founder !== (company?.founder || '')) manualFields.add('founder');
      if (location !== (company?.location || '')) manualFields.add('location');

      const companyData = {
        name,
        sector,
        stage: document.getElementById('edit-company-stage').value,
        status,
        investmentDate: document.getElementById('edit-company-date').value || null,
        investmentAmount,
        entryValuation,
        currentValuation,
        ownership,
        netValue,
        moic,
        founder,
        founderEmail: document.getElementById('edit-company-founder-email').value || null,
        location,
        description,
        coingeckoId: document.getElementById('edit-company-coingecko-id').value.trim().toLowerCase() || null,
        manualFields: [...manualFields]
      };

      // Add exit-specific fields
      if (status === 'Exited') {
        companyData.exitDate = document.getElementById('edit-company-exit-date').value || null;
        companyData.exitProceeds = parseInt(document.getElementById('edit-company-exit-proceeds').value) || 0;
        // Clear partial exit fields
        companyData.partialExitDate = null;
        companyData.amountRealized = 0;
        companyData.remainingOwnership = 0;
        companyData.remainingCostBasis = 0;
      } else if (status === 'Partially Exited') {
        companyData.partialExitDate = document.getElementById('edit-company-partial-exit-date').value || null;
        companyData.amountRealized = parseInt(document.getElementById('edit-company-amount-realized').value) || 0;
        companyData.remainingOwnership = parseFloat(document.getElementById('edit-company-remaining-ownership').value) || 0;
        companyData.remainingCostBasis = parseInt(document.getElementById('edit-company-remaining-cost-basis').value) || 0;
        // Clear full exit fields
        companyData.exitDate = null;
        companyData.exitProceeds = 0;
      } else {
        // Active ‚Äî clear all exit fields
        companyData.exitDate = null;
        companyData.exitProceeds = 0;
        companyData.partialExitDate = null;
        companyData.amountRealized = 0;
        companyData.remainingOwnership = 0;
        companyData.remainingCostBasis = 0;
      }

      const result = await Database.updateCompany(companyId, companyData);
      
      if (result.success) {
        hideEditCompanyModal();
        companiesData = await Database.getCompanies();
        renderSummary();
        renderTable();
        showToast('Company updated successfully!');
      } else {
        showToast('Error updating company', true);
      }
    }

    // Delete Company
    async function deleteCompany(companyId, companyName) {
      if (!confirm(`Are you sure you want to delete "${companyName}"? This cannot be undone.`)) {
        return;
      }

      const result = await Database.deleteCompany(companyId);
      
      if (result.success) {
        companiesData = await Database.getCompanies();
        renderSummary();
        renderTable();
        showToast('Company deleted successfully');
      } else {
        showToast('Error deleting company', true);
      }
    }

    // Toggle company detail row
    function toggleDetail(companyId) {
      const row = document.getElementById('detail-' + companyId);
      if (row) {
        const isHidden = row.style.display === 'none';
        row.style.display = isHidden ? 'table-row' : 'none';
      }
    }

    // ========================
    // SMART COMPANY NAME MATCHING
    // ========================
    function findMatchingCompany(folderName, companies) {
      const strip = (n) => (n || '').toLowerCase().replace(/[^a-z0-9\s]/g, '').trim();
      const folderStrip = strip(folderName);
      const folderWords = folderStrip.split(/\s+/).filter(w => w.length >= 3);
      const folderFirstWord = folderStrip.split(/\s+/)[0] || '';

      let bestMatch = null;
      let bestScore = 0;

      for (const c of companies) {
        const nameStrip = strip(c.name);
        const nameWords = nameStrip.split(/\s+/).filter(w => w.length >= 3);
        const nameFirstWord = nameStrip.split(/\s+/)[0] || '';
        let score = 0;

        // Exact match after stripping
        if (nameStrip === folderStrip) { score = 100; }
        // One contains the other fully
        else if (nameStrip.includes(folderStrip) || folderStrip.includes(nameStrip)) { score = 80; }
        // First word matches (e.g. "Aggregata" in both)
        else if (folderFirstWord.length >= 3 && folderFirstWord === nameFirstWord) { score = 70; }
        // Any significant word from folder appears in company name
        else if (folderWords.some(w => nameStrip.includes(w))) { score = 50; }
        // Any significant word from company name appears in folder
        else if (nameWords.some(w => folderStrip.includes(w))) { score = 50; }

        if (score > bestScore) {
          bestScore = score;
          bestMatch = c;
        }
      }

      // Only return if we have a reasonable match (score >= 50)
      return bestScore >= 50 ? bestMatch : null;
    }

    // ========================
    // AI SYNC FROM GOOGLE DRIVE
    // ========================
    async function aiSync() {
      const btn = document.getElementById('ai-sync-btn');
      const btnText = document.getElementById('ai-sync-text');
      btn.disabled = true;
      btnText.textContent = 'Loading folders...';

      try {
        // Step 1: Get list of company folders from Drive
        const listRes = await fetch('/api/ai-sync?action=list');
        const listData = await listRes.json();
        
        if (!listData.success || !listData.folders?.length) {
          showToast('No folders found in Drive. Check GOOGLE_DRIVE_FOLDER_ID.', true);
          return;
        }

        const totalFolders = listData.folders.length;
        let processed = 0;
        let updated = 0;
        let created = 0;

        // Step 2: Analyze each folder one at a time
        for (const folder of listData.folders) {
          processed++;
          const cleanName = folder.name.replace(/^\d+[\.\)\-]\s*/, '').trim();
          btnText.textContent = `ü§ñ ${processed}/${totalFolders}: ${cleanName}`;

          try {
            const analyzeRes = await fetch(`/api/ai-sync?action=analyze&folderId=${folder.id}&folderName=${encodeURIComponent(folder.name)}`);
            const analyzeData = await analyzeRes.json();
            
            if (!analyzeData.success || !analyzeData.data) continue;

            const aiData = analyzeData.data;

            // Smart company matching ‚Äî handles "Aggregata (Gata)" vs "Aggregata (renamed as Gata)" etc.
            const existing = findMatchingCompany(cleanName, companiesData);

            if (existing) {
              // Smart merge: only update fields NOT manually edited
              const manualFields = existing.manualFields || [];
              const updateData = {};

              if (!manualFields.includes('description') && aiData.description) {
                updateData.description = aiData.description;
              }
              if (!manualFields.includes('sector') && aiData.sector) {
                updateData.sector = aiData.sector;
              }
              if (!manualFields.includes('stage') && aiData.stage) {
                updateData.stage = aiData.stage;
              }
              if (!manualFields.includes('founder') && aiData.founders?.length) {
                updateData.founder = aiData.founders.join(', ');
              }
              if (!manualFields.includes('location') && aiData.location) {
                updateData.location = aiData.location;
              }

              // Always update AI-specific fields (these are AI-only, never manually set)
              if (aiData.latestUpdates?.length) updateData.aiUpdates = aiData.latestUpdates;
              if (aiData.highlights?.length) updateData.aiHighlights = aiData.highlights;
              if (aiData.keyMetrics) updateData.aiKeyMetrics = aiData.keyMetrics;
              updateData.lastAiSync = new Date().toISOString();

              if (Object.keys(updateData).length > 0) {
                await Database.updateCompany(existing.id, updateData);
                updated++;
              }
            } else {
              // Create new company
              await Database.createCompany({
                name: cleanName,
                description: aiData.description || null,
                sector: aiData.sector || '-',
                stage: aiData.stage || 'Seed',
                status: 'Active',
                founder: aiData.founders?.join(', ') || null,
                location: aiData.location || null,
                aiUpdates: aiData.latestUpdates || [],
                aiHighlights: aiData.highlights || [],
                aiKeyMetrics: aiData.keyMetrics || null,
                lastAiSync: new Date().toISOString()
              });
              created++;
              // Reload so next folders can match this new company (avoid duplicates)
              companiesData = await Database.getCompanies();
            }
          } catch (err) {
            console.error(`Error analyzing ${folder.name}:`, err);
          }
        }

        // Reload data
        companiesData = await Database.getCompanies();
        renderSummary();
        renderTable();
        showToast(`AI Sync complete! ${updated} updated, ${created} new companies from ${totalFolders} folders.`);

      } catch (error) {
        console.error('AI Sync error:', error);
        showToast('AI Sync error: ' + error.message, true);
      } finally {
        btn.disabled = false;
        btnText.textContent = 'AI Sync';
      }
    }

    // ========================
    // SYNC FROM GOOGLE SHEETS
    // ========================
    async function syncFromSheets() {
      const btn = document.getElementById('sync-sheets-btn');
      const btnText = document.getElementById('sync-sheets-text');
      btn.disabled = true;
      btnText.textContent = 'Syncing...';

      try {
        const response = await fetch('/api/sync-sheets');
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Sync failed');
        }

        if (!data.companies || data.companies.length === 0) {
          showToast('No companies found in the sheet', true);
          return;
        }

        // Match sheet data to existing Firebase companies & update/create
        let updated = 0;
        let created = 0;

        for (const sheetCompany of data.companies) {
          // Smart matching (same logic as AI sync)
          const existing = findMatchingCompany(sheetCompany.name, companiesData);

          // Build update data from the sheet (only update financial fields)
          const updateData = {};
          if (sheetCompany.investmentAmount > 0) updateData.investmentAmount = sheetCompany.investmentAmount;
          if (sheetCompany.entryValuation > 0) updateData.entryValuation = sheetCompany.entryValuation;
          if (sheetCompany.currentValuation > 0) updateData.currentValuation = sheetCompany.currentValuation;
          if (sheetCompany.ownership > 0) updateData.ownership = sheetCompany.ownership;
          if (sheetCompany.moic > 0) updateData.moic = sheetCompany.moic;
          if (sheetCompany.netValue > 0) updateData.netValue = sheetCompany.netValue;
          if (sheetCompany.investmentDate) updateData.investmentDate = sheetCompany.investmentDate;
          if (sheetCompany.investors) updateData.investors = sheetCompany.investors;

          if (existing) {
            // Update existing company
            await Database.updateCompany(existing.id, updateData);
            updated++;
          } else {
            // Create new company
            await Database.createCompany({
              name: sheetCompany.name,
              sector: '-',
              stage: 'Seed',
              status: 'Active',
              ...updateData
            });
            created++;
          }
        }

        // Reload data
        companiesData = await Database.getCompanies();
        renderSummary();
        renderTable();

        showToast(`Sync complete! ${updated} updated, ${created} created from ${data.companiesFound} sheet rows.`);

      } catch (error) {
        console.error('Sheets sync error:', error);
        showToast('Sync error: ' + error.message, true);
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Sync from Sheets';
      }
    }

    // ========================
    // REFRESH CRYPTO PRICES (CoinGecko FDV)
    // ========================
    async function refreshCryptoPrices() {
      const btn = document.getElementById('crypto-prices-btn');
      const btnText = document.getElementById('crypto-prices-text');
      
      // Find companies with coingeckoId set
      const cryptoCompanies = companiesData.filter(c => c.coingeckoId);
      
      if (cryptoCompanies.length === 0) {
        showToast('No companies have a CoinGecko ID set. Edit a company to add one.', true);
        return;
      }

      btn.disabled = true;
      btnText.textContent = 'Fetching prices...';

      try {
        const ids = cryptoCompanies.map(c => c.coingeckoId);
        
        const response = await fetch('/api/crypto-prices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });

        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to fetch prices');
        }

        let updatedCount = 0;

        for (const price of data.prices) {
          // Find matching company by coingeckoId
          const company = cryptoCompanies.find(c => c.coingeckoId === price.id);
          if (!company) continue;

          const fdv = price.fullyDilutedValuation;
          if (!fdv || fdv <= 0) continue;

          // Update company in Firestore
          const updateData = {
            currentValuation: Math.round(fdv),
            tokenPrice: price.currentPrice || null,
            marketCap: price.marketCap || null,
            priceChange24h: price.priceChange24h || null,
            cryptoPriceUpdatedAt: new Date().toISOString()
          };

          // Auto-recalculate MOIC and Net Value
          const entryVal = company.entryValuation || 0;
          const investAmt = company.investmentAmount || 0;
          if (fdv > 0 && entryVal > 0) {
            updateData.moic = fdv / entryVal;
            if (investAmt > 0) {
              updateData.netValue = Math.round(investAmt * updateData.moic);
            }
          }

          await Database.updateCompany(company.id, updateData);
          updatedCount++;
        }

        // Reload data and re-render
        companiesData = await Database.getCompanies();
        renderSummary();
        renderTable();

        showToast(`Updated ${updatedCount} token price${updatedCount !== 1 ? 's' : ''} from CoinGecko`);

      } catch (error) {
        console.error('Crypto price refresh error:', error);
        showToast('Error fetching crypto prices: ' + error.message, true);
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Refresh Crypto Prices';
      }
    }

    init();
  </script>
</body>
</html>
