<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documents | IDGX Capital</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-inner">
        <a href="index.html" class="navbar-brand">
          <div class="navbar-logo">IDG</div>
          <span>IDGX Capital</span>
        </a>
        
        <div class="navbar-nav" id="main-nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="portfolio.html" class="nav-link" id="nav-portfolio">Portfolio</a>
          <a href="personal.html" class="nav-link">My View</a>
          <a href="documents.html" class="nav-link active">Documents</a>
          <a href="admin.html" class="nav-link hidden" id="nav-admin">Admin</a>
        </div>

        <div class="navbar-user">
          <div class="user-menu">
            <button class="user-button">
              <div class="user-avatar" id="user-avatar">--</div>
              <span id="user-name">Loading...</span>
            </button>
            <div class="user-dropdown">
              <div class="dropdown-item" style="pointer-events: none;">
                <small style="color: var(--text-muted);" id="user-role-text">Role</small>
              </div>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" onclick="Auth.signOut()">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="container container-lg">
        <!-- Page Header -->
        <div class="page-header">
          <h1 class="page-title">Documents</h1>
          <p class="page-subtitle">Fund documents, reports, and company files</p>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading">
          <div class="spinner"></div>
        </div>

        <!-- Documents Content -->
        <div id="documents-content" class="hidden">
          <!-- Upload Zone (Admin/GP only) -->
          <div id="upload-section" class="card mb-8 hidden">
            <div class="card-header">
              <h3 class="card-title">Upload Document</h3>
            </div>
            <div class="card-body">
              <div class="upload-zone" id="upload-zone">
                <div class="upload-zone-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                </div>
                <div class="upload-zone-text">Drop files here or click to upload</div>
                <div class="upload-zone-hint">PDF, Word, Excel, PowerPoint (max 25MB)</div>
                <input type="file" id="file-input" style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
              </div>
              
              <!-- Upload form (shown after file selected) -->
              <div id="upload-form" class="hidden mt-6">
                <div class="grid-2">
                  <div class="form-group">
                    <label class="form-label">Document Type</label>
                    <select class="form-input form-select" id="doc-type">
                      <option value="Quarterly Report">Quarterly Report</option>
                      <option value="Annual Report">Annual Report</option>
                      <option value="Financial Statement">Financial Statement</option>
                      <option value="Term Sheet">Term Sheet</option>
                      <option value="Legal Document">Legal Document</option>
                      <option value="Board Deck">Board Deck</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Related Company (optional)</label>
                    <select class="form-input form-select" id="doc-company">
                      <option value="">Fund Level Document</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Access</label>
                  <div style="display: flex; gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="access-gp" checked> GP
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="access-lp"> LP
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="access-team"> Team
                    </label>
                  </div>
                </div>
                <div style="display: flex; gap: 12px;">
                  <button class="btn btn-primary" onclick="uploadDocument()">Upload Document</button>
                  <button class="btn btn-secondary" onclick="cancelUpload()">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="card mb-6">
            <div class="card-body" style="padding: 16px 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div class="filters">
                  <button class="filter-btn active" data-filter="all">All</button>
                  <button class="filter-btn" data-filter="Quarterly Report">Quarterly Reports</button>
                  <button class="filter-btn" data-filter="Financial Statement">Financials</button>
                  <button class="filter-btn" data-filter="Legal Document">Legal</button>
                </div>
                <div class="search-box" style="min-width: 280px;">
                  <span class="search-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                  </span>
                  <input type="text" class="search-input" id="search-input" placeholder="Search documents...">
                </div>
              </div>
            </div>
          </div>

          <!-- Documents List -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">All Documents</h3>
              <span class="badge badge-default" id="doc-count">0 documents</span>
            </div>
            <div class="card-body" id="documents-list">
              <div class="empty-state">
                <div class="empty-state-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                </div>
                <h3>No documents yet</h3>
                <p>Upload your first document to get started</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="database.js"></script>
  <script src="storage.js"></script>

  <script>
    let allDocuments = [];
    let allCompanies = [];
    let selectedFile = null;
    let currentFilter = 'all';
    let currentSearch = '';

    // Get file icon
    function getFileIcon(mimeType) {
      let icon = 'file';
      if (mimeType?.includes('pdf')) icon = 'file-pdf';
      else if (mimeType?.includes('word') || mimeType?.includes('document')) icon = 'file-word';
      else if (mimeType?.includes('sheet') || mimeType?.includes('excel')) icon = 'file-excel';
      else if (mimeType?.includes('presentation') || mimeType?.includes('powerpoint')) icon = 'file-ppt';
      
      const icons = {
        'file': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>',
        'file-pdf': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>',
        'file-word': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>',
        'file-excel': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>',
        'file-ppt': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'
      };
      
      return icons[icon] || icons['file'];
    }

    // Format file size
    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Format date
    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Initialize
    async function initDocuments() {
      await Auth.init();
      
      if (!Auth.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }

      const user = Auth.currentUserData;
      document.getElementById('user-name').textContent = user?.name || 'User';
      document.getElementById('user-avatar').textContent = user?.name?.split(' ').map(n => n[0]).join('') || '?';
      document.getElementById('user-role-text').textContent = user?.role || '';

      if (user?.role === 'Admin') {
        document.getElementById('nav-admin').classList.remove('hidden');
      }
      if (user?.role === 'LP') {
        document.getElementById('nav-portfolio').classList.add('hidden');
      }

      // Show upload for Admin/GP
      if (user?.role === 'Admin' || user?.role === 'GP') {
        document.getElementById('upload-section').classList.remove('hidden');
        setupUpload();
      }

      // Load data
      await loadDocuments();
    }

    async function loadDocuments() {
      const role = Auth.currentUserData?.role;
      
      // Get documents based on role
      if (role === 'LP') {
        allDocuments = await Database.getDocumentsByRole('LP');
      } else {
        allDocuments = await Database.getDocuments();
      }

      // Get companies for upload dropdown
      if (role === 'Admin' || role === 'GP') {
        allCompanies = await Database.getCompanies();
        const companySelect = document.getElementById('doc-company');
        allCompanies.forEach(c => {
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = c.name;
          companySelect.appendChild(option);
        });
      }

      // Render documents
      renderDocuments();

      // Setup filters
      setupFilters();

      // Hide loading
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('documents-content').classList.remove('hidden');
    }

    function renderDocuments() {
      let docs = [...allDocuments];

      // Apply filter
      if (currentFilter !== 'all') {
        docs = docs.filter(d => d.type === currentFilter);
      }

      // Apply search
      if (currentSearch) {
        const search = currentSearch.toLowerCase();
        docs = docs.filter(d => 
          d.name?.toLowerCase().includes(search) ||
          d.type?.toLowerCase().includes(search)
        );
      }

      document.getElementById('doc-count').textContent = `${docs.length} document${docs.length !== 1 ? 's' : ''}`;

      if (docs.length === 0) {
        document.getElementById('documents-list').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
            </div>
            <h3>No documents found</h3>
            <p>Try adjusting your filters or upload a new document</p>
          </div>
        `;
        return;
      }

      const html = docs.map(doc => {
        const company = doc.companyId ? allCompanies.find(c => c.id === doc.companyId) : null;
        return `
          <div class="document-item">
            <div class="document-icon">
              ${getFileIcon(doc.mimeType)}
            </div>
            <div class="document-info">
              <div class="document-name">${doc.name}</div>
              <div class="document-meta">
                ${doc.type} ${company ? '· ' + company.name : ''} · ${formatFileSize(doc.size)} · ${formatDate(doc.uploadedAt)}
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <a href="${doc.storageUrl}" target="_blank" class="btn btn-secondary btn-sm">Download</a>
              ${Auth.currentUserData?.role === 'Admin' ? `<button class="btn btn-ghost btn-sm" onclick="deleteDoc('${doc.id}', '${doc.storagePath}')">Delete</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('documents-list').innerHTML = html;
    }

    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderDocuments();
        });
      });

      document.getElementById('search-input').addEventListener('input', (e) => {
        currentSearch = e.target.value;
        renderDocuments();
      });
    }

    function setupUpload() {
      const uploadZone = document.getElementById('upload-zone');
      const fileInput = document.getElementById('file-input');

      // Click to upload
      uploadZone.addEventListener('click', () => fileInput.click());

      // File selected
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          selectedFile = e.target.files[0];
          showUploadForm();
        }
      });

      // Drag and drop
      uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
      });

      uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
      });

      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
          selectedFile = e.dataTransfer.files[0];
          showUploadForm();
        }
      });
    }

    function showUploadForm() {
      document.getElementById('upload-zone').style.display = 'none';
      document.getElementById('upload-form').classList.remove('hidden');
    }

    function cancelUpload() {
      selectedFile = null;
      document.getElementById('file-input').value = '';
      document.getElementById('upload-zone').style.display = 'block';
      document.getElementById('upload-form').classList.add('hidden');
    }

    async function uploadDocument() {
      if (!selectedFile) return;

      const docType = document.getElementById('doc-type').value;
      const companyId = document.getElementById('doc-company').value || null;
      
      const accessRoles = ['Admin'];
      if (document.getElementById('access-gp').checked) accessRoles.push('GP');
      if (document.getElementById('access-lp').checked) accessRoles.push('LP');
      if (document.getElementById('access-team').checked) accessRoles.push('Team');

      // Show loading
      const btn = document.querySelector('#upload-form .btn-primary');
      btn.disabled = true;
      btn.textContent = 'Uploading...';

      const result = await Storage.uploadDocument(selectedFile, companyId, docType, accessRoles);

      if (result.success) {
        cancelUpload();
        await loadDocuments();
        btn.disabled = false;
        btn.textContent = 'Upload Document';
      } else {
        alert('Error uploading document: ' + result.error);
        btn.disabled = false;
        btn.textContent = 'Upload Document';
      }
    }

    async function deleteDoc(docId, storagePath) {
      if (!confirm('Are you sure you want to delete this document?')) return;
      
      const result = await Storage.deleteDocument(docId, storagePath);
      if (result.success) {
        await loadDocuments();
      } else {
        alert('Error deleting document');
      }
    }

    // Initialize
    initDocuments();
  </script>
</body>
</html>
